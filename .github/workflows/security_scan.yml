name: ğŸ›¡ï¸ Security Vulnerability Scan (Trivy)

# Este workflow se ejecuta en dos eventos principales:
# 1. Cuando se sube cÃ³digo a la rama 'main'.
# 2. Cuando se crea o se actualiza un Pull Request.
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  trivy_scan:
    # Ejecuta el trabajo en el Ãºltimo entorno Ubuntu estable
    runs-on: ubuntu-latest
    
    # Define los pasos que se ejecutarÃ¡n en este trabajo
    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4
        
      # ConstrucciÃ³n de la imagen del Front-end (FE)
      - name: ğŸ—ï¸ Build Front-end Image (fe-web)
        # Usamos el path del Dockerfile y el contexto que definimos
        run: docker build -t fe-web-image -f docker/fe/Dockerfile .
        
      # Escaneo de Seguridad del Front-end con Trivy
      # Se centra en vulnerabilidades de la imagen y los paquetes instalados.
      - name: ğŸ” Scan Front-end Image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          # Escanea la imagen construida
          image-ref: 'fe-web-image'
          # Formato de salida para GitHub Security Tab
          format: 'github'
          # Nombre del resultado del escaneo
          output: 'trivy-results-fe.sarif'
          # Niveles de severidad a reportar (CrÃ­tico, Alto)
          severity: 'CRITICAL,HIGH'
          
      # Subir el informe SARIF para que aparezca en la pestaÃ±a de Seguridad
      - name: ğŸ“¤ Upload Trivy results to GitHub Security Tab (FE)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results-fe.sarif'

      # --- Escaneo del Task Worker (BE) ---
      
      # ConstrucciÃ³n de la imagen del Worker
      - name: ğŸ—ï¸ Build Task Worker Image
        run: docker build -t task-worker-image -f docker/worker/Dockerfile-php .

      # Escaneo de Seguridad del Task Worker con Trivy
      - name: ğŸ” Scan Task Worker Image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'task-worker-image'
          format: 'github'
          output: 'trivy-results-worker.sarif'
          severity: 'CRITICAL,HIGH'
          
      # Subir el informe SARIF para el Worker
      - name: ğŸ“¤ Upload Trivy results to GitHub Security Tab (Worker)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results-worker.sarif'

      # Nota: Para un escaneo mÃ¡s completo, se podrÃ­a escanear tambiÃ©n el cÃ³digo fuente
      # (filesystem) en lugar de solo la imagen.

      # Paso adicional para asegurar que el workflow se ejecute correctamente
      - name: âœ… Workflow Execution Confirmation
        run: echo "ğŸ›¡ï¸ Security scan workflow executed successfully!"
        if: always()
