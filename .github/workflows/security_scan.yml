# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: üõ°Ô∏è Security & Quality Pipeline (Trivy + PHPStan)

# Este workflow se ejecuta en push a main, Pull Requests y puede ser ejecutado manualmente (workflow_dispatch).
on:
  push:
    branches: [ "main" ]
  pull_request:
    # Las ramas a monitorizar deben ser un subconjunto de las de 'push'
    branches: [ "main" ]
  workflow_dispatch: # Permite ejecutar el workflow manualmente

# Permisos a nivel de workflow (todos los jobs)
permissions:
  contents: read

jobs:
  trivy_scan:
    # Permisos espec√≠ficos para este job (M√≠nimo Privilegio)
    permissions:
      contents: read       # Para que actions/checkout pueda obtener el c√≥digo
      security-events: write # Para que github/codeql-action/upload-sarif pueda subir los resultados SARIF
      actions: read          # Requerido para repositorios privados
      
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      # --- Escaneo del Front-end (FE) ---

      # Construcci√≥n de la imagen del Front-end (FE)
      - name: üèóÔ∏è Build Front-end Image (fe-web)
        # Usamos el contexto ra√≠z ('.') para acceder a 'docker/fe/Dockerfile' y 'src/fe/'
        run: docker build -t fe-web-image -f docker/fe/Dockerfile .

      - name: üîé Scan Front-end Image with Trivy
        # Usamos un hash de commit espec√≠fico para inmutabilidad
        uses: aquasecurity/trivy-action@7b7aa264d83dc58691451798b4d117d53d21edfe
        with:
          image-ref: 'fe-web-image'
          # Se usa el template SARIF est√°ndar para la integraci√≥n con GitHub Security tab
          format: 'template'
          template: '@/contrib/sarif.tpl'
          output: 'trivy-results-fe.sarif'
          # Solo reportar las vulnerabilidades m√°s graves
          severity: 'CRITICAL,HIGH'

      - name: üì§ Upload Front-end Trivy results to GitHub Security tab
        # Se usa la versi√≥n m√°s reciente v4 del uploader SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results-fe.sarif'
          # A√ëADIDO: Categor√≠a √önica para el Front-end
          category: 'trivy-fe-scan'

      # --- Escaneo del Task Worker (BE) ---

      # Construcci√≥n de la imagen del Worker
      - name: üèóÔ∏è Build Task Worker Image
        # Usamos el contexto ra√≠z ('.') para acceder a 'docker/worker/Dockerfile-php' y 'src/worker/'
        run: docker build -t task-worker-image -f docker/worker/Dockerfile-php .

      - name: üîé Scan Task Worker Image with Trivy
        uses: aquasecurity/trivy-action@7b7aa264d83dc58691451798b4d117d53d21edfe
        with:
          image-ref: 'task-worker-image'
          format: 'template'
          template: '@/contrib/sarif.tpl'
          output: 'trivy-results-worker.sarif'
          severity: 'CRITICAL,HIGH'

      - name: üì§ Upload Worker Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results-worker.sarif'
          # A√ëADIDO: Categor√≠a √önica para el Worker
          category: 'trivy-worker-scan'

      # Paso final de confirmaci√≥n
      - name: ‚úÖ Workflow Execution Confirmation
        run: echo "üõ°Ô∏è Security scan workflow executed successfully!"
        if: always()

  code_quality:
    name: üìè Code Quality (PHPStan)
    # Este job se ejecutar√° en paralelo con trivy_scan
    runs-on: ubuntu-latest
    
    # ‚ö†Ô∏è Nota: Este job ASUME que tiene un archivo composer.json en la ra√≠z del proyecto
    # y que PHPStan est√° configurado.

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Set up PHP
        # Usamos una versi√≥n similar a la del Dockerfile para consistencia
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo, pdo_pgsql, redis
          coverage: none # No necesitamos cobertura para este paso

      - name: ‚öôÔ∏è Install Composer Dependencies (PHPStan)
        # Esto instalar√° PHPStan si est√° definido como una dependencia de desarrollo en composer.json
        run: composer install --prefer-dist --no-progress --no-suggest
        # Nota: Si no tiene composer.json, este paso fallar√°.

      - name: üî¨ Run PHPStan Analysis (Level 0 - Basic)
        # Escanea los directorios de c√≥digo PHP
        # El nivel 0 es el m√°s indulgente. Deber√≠a incrementarse hasta el nivel 9.
        run: ./vendor/bin/phpstan analyse src/fe src/worker --level 0
        
      - name: ‚úÖ Code Quality Confirmation
        run: echo "Code quality check with PHPStan passed!"
