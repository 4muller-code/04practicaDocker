# This workflow performs security scanning and code quality analysis
# It includes Trivy for container security and PHPStan for static analysis

name: üõ°Ô∏è Security & Code Quality

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Job de escaneo de seguridad (security_scan) - Se mantiene sin cambios ya que ya est√° corregido.
  security_scan:
    permissions:
      contents: read
      security-events: write
      actions: read
    name: üîç Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      # Construcci√≥n de la imagen del Front-end (FE)
      - name: üèóÔ∏è Build Front-end Image (fe-web)
        run: docker build -t fe-web-image -f docker/fe/Dockerfile .

      - name: üîé Scan Front-end Image with Trivy
        uses: aquasecurity/trivy-action@7b7aa264d83dc58691451798b4d117d53d21edfe
        with:
          image-ref: 'fe-web-image'
          format: 'template'
          template: '@/contrib/sarif.tpl'
          output: 'trivy-results-fe.sarif'
          severity: 'CRITICAL,HIGH'

      - name: üì§ Upload Front-end Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results-fe.sarif'
          category: trivy-fe-scan 

      # --- Escaneo del Task Worker (BE) ---

      # Construcci√≥n de la imagen del Worker
      - name: üèóÔ∏è Build Task Worker Image
        run: docker build -t task-worker-image -f docker/worker/Dockerfile-php .

      - name: üîé Scan Task Worker Image with Trivy
        uses: aquasecurity/trivy-action@7b7aa264d83dc58691451798b4d117d53d21edfe
        with:
          image-ref: 'task-worker-image'
          format: 'template'
          template: '@/contrib/sarif.tpl'
          output: 'trivy-results-worker.sarif'
          severity: 'CRITICAL,HIGH'

      - name: üì§ Upload Worker Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results-worker.sarif'
          category: trivy-worker-scan 

      - name: ‚úÖ Security Scan Confirmation
        run: echo "üõ°Ô∏è Security scan completed successfully!"
        if: always()

  # Job de calidad de c√≥digo (code_quality) - Se mantiene sin cambios
  code_quality:
    name: üìä Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo, pdo_pgsql, pgsql, zip, redis
          coverage: none

      - name: üì¶ Install Composer dependencies
        run: |
          # Install Composer
          curl -sS https://getcomposer.org/installer | php
          php composer.phar install --no-progress --no-scripts

      - name: üîç Run PHPStan on all PHP code
        run: |
          # Run PHPStan using the composer script
          composer phpstan -- --error-format=github

      - name: ‚úÖ Code Quality Confirmation
        run: echo "üìä Code quality analysis completed!"
        if: always()

  # CORREGIDO: Integration tests con timeout extendido
  integration_tests:
    name: üß™ Integration Tests
    runs-on: ubuntu-latest
    needs: [security_scan, code_quality]
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üê≥ Start Docker Compose
        run: |
          # Iniciar servicios en segundo plano
          docker-compose up -d
          # Esperar un breve tiempo inicial
          sleep 5

      # AJUSTE CLAVE: Bucle de reintento para esperar hasta 120 segundos.
      - name: üîç Check service health with extended retry
        run: |
          MAX_RETRIES=24 # Duplicamos los intentos (12 -> 24)
          DELAY=5
          # Intentar hasta 24 veces (24 * 5 segundos = 120 segundos de espera total)
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES: Checking service health at http://localhost:8080..."
            docker-compose ps # Mostrar estado de los contenedores para diagn√≥stico
            
            # Intentar acceder al balanceador de carga. El flag -f falla con 4xx/5xx.
            if curl -f http://localhost:8080; then
              echo "‚úÖ Service is running and responsive (HTTP 200/3xx received)!"
              exit 0
            fi

            # Si la comprobaci√≥n fall√≥, esperar antes del pr√≥ximo intento.
            echo "Service not ready (Connection failed or HTTP Error received). Waiting $DELAY seconds..."
            sleep $DELAY
          done

          # Si el bucle termina sin √©xito, forzamos un fallo.
          echo "‚ùå ERROR: Service failed to become ready after 24 retries (120s)."
          
          # DIAGN√ìSTICO ADICIONAL: Mostrar logs y estado para saber por qu√© fall√≥.
          echo "--- DIAGNOSTIC INFO ---"
          docker-compose logs --tail 20 # Muestra los √∫ltimos 20 logs de todos los servicios
          docker-compose ps 
          echo "--- END DIAGNOSTIC INFO ---"
          
          exit 1
      
      # Aqu√≠ ir√≠a el comando de ejecuci√≥n de tests de integraci√≥n reales
      # Por ejemplo: - name: üöÄ Run actual integration tests
      #                   run: docker-compose exec fe-web php vendor/bin/phpunit --testsuite Integration

      - name: üßπ Cleanup
        run: docker-compose down
        if: always()

      - name: ‚úÖ Integration Tests Confirmation
        run: echo "üß™ Integration tests completed!"
        if: always()
