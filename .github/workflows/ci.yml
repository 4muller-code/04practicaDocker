# This workflow performs security scanning and code quality analysis
# It includes Trivy for container security and PHPStan for static analysis

name: ğŸ›¡ï¸ Security & Code Quality

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Security scanning with Trivy
  security_scan:
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      # ConstrucciÃ³n de la imagen del Front-end (FE)
      - name: ğŸ—ï¸ Build Front-end Image (fe-web)
        run: docker build -t fe-web-image -f docker/fe/Dockerfile .

      - name: ğŸ” Scan Front-end Image with Trivy
        uses: aquasecurity/trivy-action@7b7aa264d83dc58691451798b4d117d53d21edfe
        with:
          image-ref: 'fe-web-image'
          format: 'template'
          template: '@/contrib/sarif.tpl'
          output: 'trivy-results-fe.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ğŸ“¤ Upload Front-end Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results-fe.sarif'
          category: trivy-fe-scan # <--- CORRECCIÃ“N 1: CategorÃ­a Ãºnica para FE

      # --- Escaneo del Task Worker (BE) ---

      # ConstrucciÃ³n de la imagen del Worker
      - name: ğŸ—ï¸ Build Task Worker Image
        run: docker build -t task-worker-image -f docker/worker/Dockerfile-php .

      - name: ğŸ” Scan Task Worker Image with Trivy
        uses: aquasecurity/trivy-action@7b7aa264d83dc58691451798b4d117d53d21edfe
        with:
          image-ref: 'task-worker-image'
          format: 'template'
          template: '@/contrib/sarif.tpl'
          output: 'trivy-results-worker.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ğŸ“¤ Upload Worker Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results-worker.sarif'
          category: trivy-worker-scan # <--- CORRECCIÃ“N 2: CategorÃ­a Ãºnica para Worker

      # Paso adicional para asegurar que el workflow se ejecute correctamente
      - name: âœ… Security Scan Confirmation
        run: echo "ğŸ›¡ï¸ Security scan completed successfully!"
        if: always()

  # Code quality analysis with PHPStan
  code_quality:
    name: ğŸ“Š Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo, pdo_pgsql, pgsql, zip, redis
          coverage: none

      - name: ğŸ“¦ Install Composer dependencies
        run: |
          # Install Composer
          curl -sS https://getcomposer.org/installer | php
          php composer.phar install --no-progress --no-scripts

      - name: ğŸ” Run PHPStan on all PHP code
        run: |
          # Run PHPStan using the composer script
          composer phpstan -- --error-format=github

      - name: âœ… Code Quality Confirmation
        run: echo "ğŸ“Š Code quality analysis completed!"
        if: always()

  # Optional: Integration tests
  integration_tests:
    name: ğŸ§ª Integration Tests
    runs-on: ubuntu-latest
    needs: [security_scan, code_quality]
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Start Docker Compose
        run: |
          # Start services in background
          docker-compose up -d
          # Wait for services to be ready
          sleep 30

      - name: ğŸ” Check service health
        run: |
          # Check if services are running
          docker-compose ps
          # Test basic connectivity
          curl -f http://localhost:8080 || echo "Front-end service not ready yet"

      - name: ğŸ§¹ Cleanup
        run: docker-compose down
        if: always()

      - name: âœ… Integration Tests Confirmation
        run: echo "ğŸ§ª Integration tests completed!"
        if: always()
